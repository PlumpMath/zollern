;;; Sieve of Eratosthenes

(const syscall_write 1)
(const stdout 1)
(const newline 0x0A)

(const N 1000)

(mem strbuf 512)
(mem intbuf (* 8 N))

(fun (write buf)
  (return (syscall syscall_write stdout buf (strlen buf))))

(fun (strlen str)
  (var l 0)
again
  (goto done (not (b@ str l)))
  (= l (+ l 1))
  (goto again)
done
  (return l))

(fun (strint buf i)
  (var p buf)
  (var b buf)
  (var t)
next-digit
  (b@= p (+ (% i 10) 48))
  (= p (+ p 1))
  (= i (/ i 10))
  (goto next-digit i)
  (b@= p 0)
reverse-next
  (= p (- p 1))
  (= t (b@ b))
  (b@= b (b@ p))
  (b@= p t)
  (= b (+ b 1))
  (goto reverse-next (> p b)))

(fun (init-intbuf)
  (var i 0)
again
  (goto done (> i N))
  (b@= intbuf i 0)
  (= i (+ i 1))
  (goto again)
done)

(fun (print-intbuf)
  (var i 2)
again
  (goto done (> i N))
  (goto skip (b@ intbuf i))
  (strint strbuf i)
  (write strbuf)
  (write "\n")
skip
  (= i (+ i 1))
  (goto again)
done)

(fun (set-intbuf f)
  (var i (+ f f))
again
  (goto done (> i N))
  (b@= intbuf i 1)
  (= i (+ i f))
  (goto again)
done)

(fun (sieve-intbuf)
  (var p 2)
again
  (goto done (> (* p p) N))
  (goto skip (b@ intbuf p))
  (set-intbuf p)
skip
  (= p (+ p 1))
  (goto again)
done)

(fun (main)
  (write "Prime numbers:\n")
  (init-intbuf)
  (sieve-intbuf)
  (print-intbuf))
