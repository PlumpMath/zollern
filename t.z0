;; Utilities

(def (seq ?f ?start ?inc ?a)
  (?f ?a ?start))

(def (seq ?f ?start ?inc ?a ?b . ?rest)
  (begin (?f ?a ?start) (seq ?f (+ ?start ?inc) ?inc ?b . ?rest)))

(def (defenum . ?rest)
  (seq def 0 1 . ?rest))

;; Registers

(def r0 (reg 0))
(def r1 (reg 1))
(def r2 (reg 2))
(def r3 (reg 3))
(def r4 (reg 4))
(def r5 (reg 5))
(def r6 (reg 6))
(def r7 (reg 7))

;; Characters

(defenum
  ;; 0x00
  :nul :soh :stx :etx :eot :enq :ack :bel
  :bs  :ht  :nl  :vt  :np  :cr  :so  :si
  :dle :dc1 :dc2 :dc3 :dc4 :nak :syn :etb
  :can :em  :sub :esc :fs  :gs  :rs  :us

  ;; 0x20
  :spc :!   :dq  :#   :$   :%   :&   :sq
  :lp  :rp  :*   :+   :,   :-   :.   :/
  :0   :1   :2   :3   :4   :5   :6   :7
  :8   :9   ::   :sc  :<   :=   :>   :?

  ;; 0x40
  :@   :A   :B   :C   :D   :E   :F   :G
  :H   :I   :J   :K   :L   :M   :N   :O
  :P   :Q   :R   :S   :T   :U   :V   :W
  :X   :Y   :Z   :[   :bsl :]   :^   :_

  ;; 0x60
  :bt  :a   :b   :c   :d   :e   :f   :g
  :h   :i   :j   :k   :l   :m   :n   :o
  :p   :q   :r   :s   :t   :u   :v   :w
  :x   :y   :z   :{   :bar :}   :~   :del)

;; Instructions

(def (set (reg ?reg) ?val)
  (1 0x48 0xc7 (+ 0xc0 ?reg))
  (4 ?val))

(def (syscall)
  (1 0x0F 0x05))

;; Syscalls

(def syscall-reg-arg1 r7)
(def syscall-reg-arg2 r6)
(def syscall-reg-arg3 r2)
(def syscall-reg-arg4 r10)
(def syscall-reg-arg5 r8)
(def syscall-reg-arg6 r9)
(def syscall-reg-nr   r0)

(def syscall-nr-exit  60)
(def syscall-nr-write  1)

(code start
  (set syscall-reg-arg1 0)
  (set syscall-reg-arg2 message)
  (set syscall-reg-arg3 (- message:end message))
  (set syscall-reg-nr   syscall-nr-write)
  (syscall)
  (set syscall-reg-nr   syscall-nr-exit)
  (set syscall-reg-arg1 42)
  (set syscall-reg-nr   syscall-nr-exit)
  (syscall))

(code
message
  (1 :H :e :l :l :o :spc  :W :o :r :l :d :nl)
message:end)
